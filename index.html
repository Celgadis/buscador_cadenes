<input type="file" id="fileInput" multiple />
<script>
  const listaRegex = [
    /rgb[^)]+[)]/,
    /\$[^; ]+/,
    /#[^;^ ]+/,
    /.{3,}/
  ];

  const palabrasClave = [
    {
      palabra: "color:",
      contador: 0,
      resultados: {}
    },
    {
      palabra: "border:",
      contador: 0,
      resultados: {}
    }];
  // const palabrasClave = ['color', 'border', 'fallo']; // Cambia esto segÃºn tus necesidades

  document.getElementById('fileInput').addEventListener('change', async (event) => {
    const archivos = Array.from(event.target.files);

    for (const archivo of archivos) {
      await procesarArchivo(archivo);
    }
    await descargarResultados();
  });

  // FunciÃ³n que lee un archivo y busca las palabras clave lÃ­nea por lÃ­nea
  async function procesarArchivo(archivo) {
    const contenido = await leerArchivoComoTexto(archivo);
    const lineas = contenido.split('\n');

    console.log(`ðŸ“„ Procesando archivo: ${archivo.name}`);

    for (let i = 0; i < lineas.length; i++) {
      const linea = lineas[i];
      for (const clave of palabrasClave) {
        let palabra = clave.palabra;
        if (linea.toLowerCase().includes(palabra.toLowerCase())) {
          let resultado = `[${archivo.name}] LÃ­nea ${i + 1}: ${linea}`;
          //console.log(resultado);
          clave.contador++;
          let valor = linea.split(":");
          valor = valor[1].split("\r");
          valor = valor[0].trim();
          let coincidencia = null;
          for (const regex of listaRegex) {
            coincidencia = valor.match(regex)
            if (coincidencia) {
              coincidencia = coincidencia[0]
              //console.log("coincidencia:", coincidencia)
              break;
            }
          }
          
          
          /*if(clave.resultados[coincidencia]==undefined){
              
        }else{
          contador=clave.resultados[coincidencia].contador;
          console.log("trobat "+coincidencia);
        }*/
          let existe=clave.resultados.hasOwnProperty(coincidencia);
          if (!existe) {
            clave.resultados[coincidencia] =   {
              linea: resultado,
              valor: coincidencia,
              contador: 1
            }
          } else {
            
            clave.resultados[coincidencia].contador++;
          }


        }
      }
    }
  }

  // FunciÃ³n para leer archivo como texto usando FileReader y promesa
  function leerArchivoComoTexto(archivo) {
    return new Promise((resolve, reject) => {
      const lector = new FileReader();

      lector.onload = (e) => resolve(e.target.result);
      lector.onerror = (e) => reject(e);

      lector.readAsText(archivo);
    });
  }


  async function descargarResultados() {

    // 1. Convertimos el array en un string
    const contenido = JSON.stringify(palabrasClave)

    // 2. Creamos un blob con tipo texto
    const blob = new Blob([contenido], { type: 'text/plain' });

    // 3. Creamos un URL para el blob
    const url = URL.createObjectURL(blob);

    // 4. Creamos un <a> y simulamos un clic
    const enlace = document.createElement('a');
    enlace.href = url;
    enlace.download = 'resultados.json';
    document.body.appendChild(enlace);
    enlace.click();

    // 5. Limpiamos
    document.body.removeChild(enlace);
    URL.revokeObjectURL(url);
  }

  function reemplazarRgbPorHexRgb(texto) {
    return texto.replace(/rgba?\(\s*(\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\s*\)/g,
      (_, r, g, b, a) => {
        const hex =
          "#" +
          [r, g, b]
            .map((x) => parseInt(x).toString(16).padStart(2, "0"))
            .join("");

        return a !== undefined ? `rgba(${hex}, ${a})` : `rgb(${hex})`;
      });
  }

</script>