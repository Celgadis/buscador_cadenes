<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    .card {
      display: flex;
      flex-direction: column;
     
    }
    .resultado{ display:flex;
      flex-direction: column;
      gap:20px;}

    .coincidencia {
      display: flex;
      width: 100%;
      gap: 30px
    }

    .muestra {
       gap:20px;
      height: 20px;
      width: 20px;
      border: 2px solid black;
      display: flex;
    }
  </style>
</head>

<body>
  <h3>Lista de archivos scss a revisar:</h3>
  <input type="file" id="fileInput" multiple />
  <div class="palabras">
    <ul>

    </ul>
  </div>
  <div class="resultado"></div>
  <div class="molde">
    <div class="card">
      <div class="coincidencia">
        <span class="muestra"></span>
        <span class="valor"></span>
        <span class="contador"></span>
        <span>
          <label>selector de color<input type="color" name="color" class="picker"></label>
          <input type="text" name="hexcolor" class="hexcolor">
        </span>
        <span>
          <label>modificar:<input type="checkbox" class="modificar"></label>
        </span>
      </div>
      <div class="contenedor-coincidencias">

        <ul class="coincidencias">
        </ul>
      </div>
    </div>
    <input type="button" value="modificar" class="descargar-modificacion">
  </div>
</body>

</html>


<script>
  //expresiones regulares para separar rbg, variables, hexadecimales y el resto, en hexadecimales y rgb ignorara el alpha (en el rgb se controla mas adelante)
  const listaRegex = [
    /rgb[^)]+[)]/,
    /\$[^;^ ^!]+/,
    /#[^;^ ^)^,^!]{3,6}/,
    /.{3,}/
  ];


  const palabrasClave = [
    {
      palabra: "color:",
      contador: 0,
      resultados: {}
    },
    {
      palabra: "border:",
      contador: 0,
      resultados: {}
    }];

  const listaResultados = {};
  //const listaIndices=[]; //listado con los indices de las claves del objeto, para facilitar su acceso

  document.getElementById('fileInput').addEventListener('change', async (event) => {
    const archivos = Array.from(event.target.files);

    for (const archivo of archivos) {
      await procesarArchivo(archivo);
    }
    //await descargarResultados();
    await mostrarResultados();
  });



  // FunciÃ³n que lee un archivo y busca las palabras clave lÃ­nea por lÃ­nea
  async function procesarArchivo(archivo) {
    const contenido = await leerArchivoComoTexto(archivo);
    const lineas = contenido.split('\n');

    console.log(`ðŸ“„ Procesando archivo: ${archivo.name}`);
    let id=0;
    for (let i = 0; i < lineas.length; i++) {
      const linea = lineas[i];
      for (const item of palabrasClave) {
        let palabra = item.palabra;
        if (linea.toLowerCase().includes(palabra.toLowerCase())) {
          let resultado = `[${archivo.name}] LÃ­nea ${i + 1}: ${linea}`;
          //console.log(resultado);
          item.contador++;
          let valor = linea.split(":");
          valor = valor[1].split("\r");
          valor = valor[0].trim();
          let coincidencia = null;
          let regexIndex = 0
          let original = null;
          let cambiado = null
          //filtrado a traves de las regex
          for (const regex of listaRegex) {
            coincidencia = valor.match(regex)
            if (coincidencia) {
              coincidencia = coincidencia[0]
              if (regexIndex == 0) {//si es un color rgb se convierte a hex
                original = coincidencia; //guardo el valor de coincidencia original
                coincidencia = reemplazarRgbPorHexRgb(coincidencia);
                cambiado = coincidencia; //guardo el valor cambiado a hexadecimal dentro del rgb
                coincidencia = coincidencia.match(listaRegex[2])[0]
              }
              if (regexIndex == 2) {
                original = coincidencia;
                coincidencia = coincidencia.toLowerCase();
                coincidencia = expandirHex(coincidencia);
                //cambiado=coincidencia;
              }
              //console.log("coincidencia:", coincidencia)
              break;
            }
            regexIndex++
          }
          if (!coincidencia) {
            break;
          }
          //preparamos la clave de orden con valores hsl para poder ver colores similares juntos
          let regexHex = /^#[0-9A-Fa-f]{3,6}$/;
          // console.log("linia",linea)
          // console.log("coincidencia",coincidencia)
          let hsl = coincidencia.match(regexHex) ? hexToHSL(coincidencia) : null
          console.log(listaResultados);
          let clave=coincidencia
          let existe = listaResultados.hasOwnProperty(clave);
          //si no se guardo esta coincidencia se crea, si no solo se aumenta el contador y se guarda la informacion de posicion
          if (!existe) {
            listaResultados[clave] = {
              id:id,
              valor: coincidencia,
              contador: 1,
              coincidencias: [],
              tipo: regexIndex,
              hsl: hsl,
              modificar:false
            }
            listaResultados[clave].coincidencias.push({
              linea: resultado,
              archivo: archivo.name,
              pos: i,
              valor: linea,
              tipo: regexIndex,
              coincidencia: coincidencia,
              original: original,
              cambiado: cambiado
            });
            //listaIndices.push(clave);
            id++;
            
          } else {
            listaResultados[clave].contador++;
            listaResultados[clave].coincidencias.push({
              linea: resultado,
              archivo: archivo.name,
              pos: i,
              valor: linea,
              tipo: regexIndex,
              coincidencia: coincidencia,
              original: original,
              cambiado: cambiado
            });
          }


        }
      }
    }
  }

  // FunciÃ³n para leer archivo como texto usando FileReader y promesa
  function leerArchivoComoTexto(archivo) {
    return new Promise((resolve, reject) => {
      const lector = new FileReader();

      lector.onload = (e) => resolve(e.target.result);
      lector.onerror = (e) => reject(e);

      lector.readAsText(archivo);
    });
  }


  async function descargarResultados(listado) {

    // 1. Convertimos el array en un string
    const contenido = JSON.stringify(listado)

    // 2. Creamos un blob con tipo texto
    const blob = new Blob([contenido], { type: 'text/plain' });

    // 3. Creamos un URL para el blob
    const url = URL.createObjectURL(blob);

    // 4. Creamos un <a> y simulamos un clic
    const enlace = document.createElement('a');
    enlace.href = url;
    enlace.download = 'resultados.json';
    document.body.appendChild(enlace);
    enlace.click();

    // 5. Limpiamos
    document.body.removeChild(enlace);
    URL.revokeObjectURL(url);
  }

  function reemplazarRgbPorHexRgb(texto) {
    return texto.replace(/rgba?\(\s*(\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\s*\)/g,
      (_, r, g, b, a) => {
        const hex =
          "#" +
          [r, g, b]
            .map((x) => parseInt(x).toString(16).padStart(2, "0"))
            .join("");

        return a !== undefined ? `rgba(${hex}, ${a})` : `rgb(${hex})`;
      });
  }

  async function mostrarResultados() {
    for (const palabra of palabrasClave) {
      const contenedorPalabra = document.querySelector(".palabras ul")
      const node = document.createElement("li")
      node.innerText = `${palabra.palabra} - ${palabra.contador}`
      contenedorPalabra.appendChild(node);
    }
    let total = Object.keys(listaResultados).length
    //console.log(total)
    let totalHsl = 0
    if (total > 1) {
      const contenedorPalabra = document.querySelector(".palabras ul")
      const node = document.createElement("li")
      node.innerText = `colores distintos - ${total}`
      contenedorPalabra.appendChild(node);

    }

    const contenedor = document.querySelector(".resultado");
    const lista = ordenar(listaResultados);
    for (const coincidencia of Object.values(lista)) {
      //console.log(coincidencia)
      if (coincidencia.hasOwnProperty("hsl") && coincidencia.hsl != null) {
        totalHsl++
      }
      const card = document.querySelector(".molde .card").cloneNode(true);
      card.dataset.id=coincidencia.valor;
      card.querySelector(".valor").innerText = coincidencia.valor;
      //colorpicker y input
      const picker=card.querySelector(".picker");
      //picker.id = coincidencia.valor.replace(/\s/g, "") ;
      picker.value = coincidencia.valor;
      console.log(picker.value)
      const hexinput=card.querySelector(".hexcolor");
      hexinput.value=picker.value
      const modificar=card.querySelector(".modificar");
      modificar.dataset.id=coincidencia.valor;
      console.log(modificar)
      //eventos del picker y input
      picker.addEventListener("change",()=>{
        hexinput.value=picker.value;
        modificar.checked=true;
        modificar.dispatchEvent(new Event("change"));
      })
      hexinput.addEventListener("focusout",()=>{
        picker.value=hexinput.value;
        modificar.checked=true;
        modificar.dispatchEvent(new Event("change"));

      })
      modificar.addEventListener("change",()=>{
        console.log("id",modificar.dataset.id)
        marcarParaModificar(modificar.dataset.id);
      })



      let veces = coincidencia.contador == 1 ? "vez" : "veces";
      card.querySelector(".contador").innerText = `encontrado ${coincidencia.contador} ${veces}`;
      card.querySelector(".muestra").style.backgroundColor = coincidencia.valor
      //console.log(coincidencia);
      for (const linea of coincidencia.coincidencias) {
        const nodo = document.createElement("li");
        nodo.innerText = linea.linea
        card.querySelector(".coincidencias").appendChild(nodo);
      }
      contenedor.appendChild(card);
    }
    if (totalHsl > 0) {
      const contenedorPalabra = document.querySelector(".palabras ul")
      const node = document.createElement("li")
      node.innerText = `colores reales - ${totalHsl}`
      contenedorPalabra.appendChild(node);

    }
    //await descargarResultados(lista);
    await descargarResultados(listaResultados);
  }



  function ordenar(original) {
    // Paso 1: Obtener claves y ordenarlas
    const clavesOrdenadas = Object.keys(original).sort((a, b) => {
      const itemA = original[a];
      const itemB = original[b];

      const hslA = itemA.hsl;
      const hslB = itemB.hsl;

      const tieneHslA = hslA && typeof hslA.h === 'number';
      const tieneHslB = hslB && typeof hslB.h === 'number';

      // Priorizar los que tienen HSL
      if (tieneHslA && !tieneHslB) return -1;
      if (!tieneHslA && tieneHslB) return 1;

      // Ambos tienen HSL â†’ ordenar por h, s, l
      if (tieneHslA && tieneHslB) {
        if (hslA.h !== hslB.h) return hslA.h - hslB.h;
        if (hslA.s !== hslB.s) return hslA.s - hslB.s;
        return hslA.l - hslB.l;
      }

      // Ninguno tiene HSL â†’ ordenar alfabÃ©ticamente
      return a.localeCompare(b);
    });

    // Paso 2: Reconstruir objeto ordenado
    const objetoOrdenado = {};
    for (const clave of clavesOrdenadas) {
      objetoOrdenado[clave] = original[clave];
    }
    return objetoOrdenado;
  }


  // FunciÃ³n para convertir HEX a HSL
  function hexToHSL(hex) {
    // Quitar el # si lo tiene
    hex = hex.replace(/^#/, '');
    if (hex.length === 3) {
      hex = hex.split('').map(c => c + c).join('');
    }
    const r = parseInt(hex.slice(0, 2), 16) / 255;
    const g = parseInt(hex.slice(2, 4), 16) / 255;
    const b = parseInt(hex.slice(4, 6), 16) / 255;

    const max = Math.max(r, g, b), min = Math.min(r, g, b);
    let h, s, l = (max + min) / 2;

    if (max === min) {
      h = s = 0; // gris
    } else {
      const d = max - min;
      s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
      switch (max) {
        case r: h = ((g - b) / d + (g < b ? 6 : 0)); break;
        case g: h = ((b - r) / d + 2); break;
        case b: h = ((r - g) / d + 4); break;
      }
      h /= 6;
    }
    return { h: h * 360, s, l };
  }

  //funcion para pasar los hex de 3 caracteres a 6
  function expandirHex(hex) {
    // AsegÃºrate de que empiece con #
    if (!hex.startsWith("#")) return hex;

    // Eliminar el #
    const cleanHex = hex.slice(1);

    // Si es de 3 caracteres, duplicar cada uno
    if (cleanHex.length === 3) {
      return "#" + cleanHex.split("").map(c => c + c).join("");
    }

    // Si ya es de 6 caracteres, devolver igual
    return hex;
  }


  function marcarParaModificar(clave){
    console.log("id:",clave)
    console.log("indice:",clave)
    listaResultados[clave].modificar=document.querySelector(`.modificar[data-id="${clave}"]`).checked;
  }


  function listaModificados(){
        // Filtrar y copiar solo los que tengan modificar: true
    const soloModificados = [];

    for (const clave in listaResultados) {
      console.log("clave",clave)
      if (listaResultados[clave].modificar === true) {
        //soloModificados[clave] = original[clave];
        for(const coincidencia of listaResultados[clave].coincidencias){
          let nuevo;
          let original
          let nuevoColor=document.querySelector(`.card[data-id="${clave}"] .hexcolor` ).value;
          if(coincidencia.cambiado){
            nuevo=coincidencia.cambiado.replace(coincidencia.coincidencia,nuevoColor);
          }else{
            nuevo=nuevoColor
          }
          if(coincidencia.original){
            original=coincidencia.original;
          }else{
            original=coincidencia.valor;
          }
          soloModificados.push({
              archivo:coincidencia.archivo,
              pos:coincidencia.pos,
              original:original,
              nuevo:nuevo
            }) 
        }
      }
    }

    
    let ordenados=soloModificados.sort((a, b) => {
        // Primero comparamos por archivo
        if (a.archivo < b.archivo) return -1;
        if (a.archivo > b.archivo) return 1;

        // Si los archivos son iguales, comparamos por posiciÃ³n
        return a.pos - b.pos;
    });
    console.log(ordenados);
    return ordenados;
  }
  
  document.querySelector(".descargar-modificacion").addEventListener("click",()=>{
    listaModificados();
  })

</script>